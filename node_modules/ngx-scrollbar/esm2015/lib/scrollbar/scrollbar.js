import { NgZone, Directive } from '@angular/core';
import { Platform } from '@angular/cdk/platform';
import { fromEvent, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { NgScrollbar } from '../ng-scrollbar';
import { isWithinBounds, stopPropagation } from './common';
// @dynamic
export class Scrollbar {
    constructor(el, cmp, platform, document, zone) {
        this.el = el;
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    activatePointerEvents() {
        // Stream that emits when scrollbar thumb is dragged
        let thumbDragEvent;
        // Stream that emits when scrollbar track is clicked
        let trackClickEvent;
        // Stream that emits when scrollbar track is hovered
        let trackHoveredEvent;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.cmp.viewportPropagateMouseMove, this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((e) => isWithinBounds(e, this.el.getBoundingClientRect())), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((hovered) => this.document.onselectstart = hovered ? () => false : null));
            this.cmp.viewport.clicked.pipe(tap((e) => {
                if (e) {
                    if (isWithinBounds(e, this.thumb.clientRect)) {
                        this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, this.track.clientRect)) {
                        this.cmp.setClicked(true);
                        this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    this.cmp.setClicked(false);
                }
            }), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((e) => this.setHovered(e))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((e) => this.thumb.dragged(e))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((e) => this.track.onTrackClicked(e, this.thumb.size, this.viewportScrollSize))));
    }
    // Stream that emits when the track element is hovered
    get hovered() {
        const mouseEnter = fromEvent(this.el, 'mouseenter', { passive: true }).pipe(stopPropagation(), map(() => true));
        const mouseLeave = fromEvent(this.el, 'mouseleave', { passive: true }).pipe(stopPropagation(), map(() => false));
        return merge(mouseEnter, mouseLeave);
    }
    ngOnInit() {
        this.zone.runOutsideAngular(() => {
            // Activate pointer events on Desktop only
            if (!(this.platform.IOS || this.platform.ANDROID) && !this.cmp.pointerEventsDisabled) {
                this.activatePointerEvents().pipe(takeUntil(this.destroyed)).subscribe();
            }
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(this.cmp.scrolled, this.cmp.updated).pipe(tap(() => { var _a; return (_a = this.thumb) === null || _a === void 0 ? void 0 : _a.update(); }), takeUntil(this.destroyed)).subscribe();
        });
    }
    ngOnDestroy() {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    }
}
Scrollbar.decorators = [
    { type: Directive }
];
Scrollbar.ctorParameters = () => [
    { type: HTMLElement },
    { type: NgScrollbar },
    { type: Platform },
    { type: undefined },
    { type: NgZone }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zcmMvbGliL3Njcm9sbGJhci9zY3JvbGxiYXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFxQixNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUc5QyxPQUFPLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUzRCxXQUFXO0FBRVgsTUFBTSxPQUFnQixTQUFTO0lBa0I3QixZQUFnQyxFQUFlLEVBQ2xCLEdBQWdCLEVBQ2IsUUFBa0IsRUFDbEIsUUFBYSxFQUNiLElBQVk7UUFKWixPQUFFLEdBQUYsRUFBRSxDQUFhO1FBQ2xCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDYixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGFBQVEsR0FBUixRQUFRLENBQUs7UUFDYixTQUFJLEdBQUosSUFBSSxDQUFRO1FBaEI1QyxvREFBb0Q7UUFDakMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFnQm5ELENBQUM7SUFFRDs7T0FFRztJQUNLLHFCQUFxQjtRQUMzQixvREFBb0Q7UUFDcEQsSUFBSSxjQUErQixDQUFDO1FBQ3BDLG9EQUFvRDtRQUNwRCxJQUFJLGVBQWdDLENBQUM7UUFDckMsb0RBQW9EO1FBQ3BELElBQUksaUJBQWtDLENB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LENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNoRSxHQUFHLENBQUMsR0FBRyxFQUFFLFdBQUMsT0FBQSxNQUFBLElBQUksQ0FBQyxLQUFLLDBDQUFFLE1BQU0sRUFBRSxDQUFBLEVBQUEsQ0FBQyxFQUMvQixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFMUIsb0NBQW9DO1FBQ3BDLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUMxRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQzs7O1lBOUhGLFNBQVM7OztZQW1CNEIsV0FBVztZQXpCeEMsV0FBVztZQUhYLFFBQVE7O1lBRFcsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uRGVzdHJveSwgT25Jbml0LCBOZ1pvbmUsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBtZXJnZSwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5nU2Nyb2xsYmFyIH0gZnJvbSAnLi4vbmctc2Nyb2xsYmFyJztcbmltcG9ydCB7IFRodW1iQWRhcHRlciB9IGZyb20gJy4vdGh1bWIvdGh1bWInO1xuaW1wb3J0IHsgVHJhY2tBZGFwdGVyIH0gZnJvbSAnLi90cmFjay90cmFjayc7XG5pbXBvcnQgeyBpc1dpdGhpbkJvdW5kcywgc3RvcFByb3BhZ2F0aW9uIH0gZnJvbSAnLi9jb21tb24nO1xuXG4vLyBAZHluYW1pY1xuQERpcmVjdGl2ZSgpXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2Nyb2xsYmFyIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8vIFRodW1iIGRpcmVjdGl2ZSByZWZlcmVuY2VcbiAgcmVhZG9ubHkgdGh1bWI6IFRodW1iQWRhcHRlciB8IHVuZGVmaW5lZDtcbiAgLy8gVHJhY2sgZGlyZWN0aXZlIHJlZmVyZW5jZVxuICByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyIHwgdW5kZWZpbmVkO1xuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB0byB1bnN1YnNjcmliZSBmcm9tIGFsbCBzdHJlYW1zXG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8qKlxuICAgKiBWaWV3cG9ydCBwb2ludGVyIGV2ZW50c1xuICAgKiBUaGUgZm9sbG93aW5nIHN0cmVhbXMgYXJlIG9ubHkgYWN0aXZhdGVkIHdoZW4gKHBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpXG4gICAqL1xuICBwcm90ZWN0ZWQgdmlld3BvcnRUcmFja0NsaWNrZWQhOiBTdWJqZWN0PGFueT47XG4gIHByb3RlY3RlZCB2aWV3cG9ydFRodW1iQ2xpY2tlZCE6IFN1YmplY3Q8YW55PjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBlbDogSFRNTEVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgY21wOiBOZ1Njcm9sbGJhcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBwbGF0Zm9ybTogUGxhdGZvcm0sXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgZG9jdW1lbnQ6IGFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCB6b25lOiBOZ1pvbmUpIHtcbiAgfVxuXG4gIC8qKlxuICAgKiBBY3RpdmF0ZSBzY3JvbGxiYXIgcG9pbnRlciBldmVudHNcbiAgICovXG4gIHByaXZhdGUgYWN0aXZhdGVQb2ludGVyRXZlbnRzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdGh1bWIgaXMgZHJhZ2dlZFxuICAgIGxldCB0aHVtYkRyYWdFdmVudDogT2JzZXJ2YWJsZTxhbnk+O1xuICAgIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIHRyYWNrIGlzIGNsaWNrZWRcbiAgICBsZXQgdHJhY2tDbGlja0V2ZW50OiBPYnNlcnZhYmxlPGFueT47XG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgaG92ZXJlZFxuICAgIGxldCB0cmFja0hvdmVyZWRFdmVudDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gICAgLy8gU2V0IHRoZSBtZXRob2QgdXNlZCBmb3IgdGhlIHBvaW50ZXIgZXZlbnRzIG9wdGlvblxuICAgIGlmICh0aGlzLmNtcC5wb2ludGVyRXZlbnRzTWV0aG9kID09PSAndmlld3BvcnQnKSB7XG4gICAgICAvLyBQb2ludGVyIGV2ZW50cyB1c2luZyB0aGUgdmlld3BvcnRcbiAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gICAgICAvLyBBY3RpdmF0ZSB0aGUgcG9pbnRlciBldmVudHMgb2YgdGhlIHZpZXdwb3J0IGRpcmVjdGl2ZVxuICAgICAgdGhpcy5jbXAudmlld3BvcnQhLmFjdGl2YXRlUG9pbnRlckV2ZW50cyh0aGlzLmNtcC52aWV3cG9ydFByb3BhZ2F0ZU1vdXNlTW92ZSwgdGhpcy5kZXN0cm95ZWQpO1xuXG4gICAgICAvLyBTZXQgc3RyZWFtc1xuICAgICAgdGh1bWJEcmFnRXZlbnQgPSB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkO1xuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZDtcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50ID0gdGhpcy5jbXAudmlld3BvcnQhLmhvdmVyZWQucGlwZShcbiAgICAgICAgLy8gQ2hlY2sgaWYgdHJhY2sgaXMgaG92ZXJlZFxuICAgICAgICBtYXAoKGU6IGFueSkgPT4gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSkpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAvLyBFbmFibGUgLyBkaXNhYmxlIHRleHQgc2VsZWN0aW9uXG4gICAgICAgIHRhcCgoaG92ZXJlZDogYm9vbGVhbikgPT4gdGhpcy5kb2N1bWVudC5vbnNlbGVjdHN0YXJ0ID0gaG92ZXJlZCA/ICgpID0+IGZhbHNlIDogbnVsbClcbiAgICAgICk7XG5cbiAgICAgIHRoaXMuY21wLnZpZXdwb3J0IS5jbGlja2VkLnBpcGUoXG4gICAgICAgIHRhcCgoZTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgIGlmIChpc1dpdGhpbkJvdW5kcyhlLCB0aGlzLnRodW1iIS5jbGllbnRSZWN0KSkge1xuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkLm5leHQoZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2shLmNsaWVudFJlY3QpKSB7XG4gICAgICAgICAgICAgIHRoaXMuY21wLnNldENsaWNrZWQodHJ1ZSk7XG4gICAgICAgICAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQubmV4dChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZChmYWxzZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUG9pbnRlciBldmVudHMgbWV0aG9kIGlzIHVzaW5nICdzY3JvbGxiYXInXG4gICAgICB0aHVtYkRyYWdFdmVudCA9IHRoaXMudGh1bWIhLmNsaWNrZWQ7XG4gICAgICB0cmFja0NsaWNrRXZlbnQgPSB0aGlzLnRyYWNrIS5jbGlja2VkO1xuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQgPSB0aGlzLmhvdmVyZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIGhvdmVyZWQgZXZlbnRcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50LnBpcGUodGFwKChlOiBib29sZWFuKSA9PiB0aGlzLnNldEhvdmVyZWQoZSkpKSxcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0aHVtYiBkcmFnIGV2ZW50XG4gICAgICB0aHVtYkRyYWdFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRodW1iIS5kcmFnZ2VkKGUpKSksXG4gICAgICAvLyBBY3RpdmF0ZSBzY3JvbGxiYXIgdHJhY2sgY2xpY2sgZXZlbnRcbiAgICAgIHRyYWNrQ2xpY2tFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRyYWNrIS5vblRyYWNrQ2xpY2tlZChlLCB0aGlzLnRodW1iIS5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSkpKVxuICAgICk7XG4gIH1cblxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHRoZSB0cmFjayBlbGVtZW50IGlzIGhvdmVyZWRcbiAgcHJvdGVjdGVkIGdldCBob3ZlcmVkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IG1vdXNlRW50ZXIgPSBmcm9tRXZlbnQodGhpcy5lbCwgJ21vdXNlZW50ZXInLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShcbiAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxuICAgICAgbWFwKCgpID0+IHRydWUpXG4gICAgKTtcbiAgICBjb25zdCBtb3VzZUxlYXZlID0gZnJvbUV2ZW50KHRoaXMuZWwsICdtb3VzZWxlYXZlJywgeyBwYXNzaXZlOiB0cnVlIH0pLnBpcGUoXG4gICAgICBzdG9wUHJvcGFnYXRpb24oKSxcbiAgICAgIG1hcCgoKSA9PiBmYWxzZSlcbiAgICApO1xuICAgIHJldHVybiBtZXJnZShtb3VzZUVudGVyLCBtb3VzZUxlYXZlKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAvLyBBY3RpdmF0ZSBwb2ludGVyIGV2ZW50cyBvbiBEZXNrdG9wIG9ubHlcbiAgICAgIGlmICghKHRoaXMucGxhdGZvcm0uSU9TIHx8IHRoaXMucGxhdGZvcm0uQU5EUk9JRCkgJiYgIXRoaXMuY21wLnBvaW50ZXJFdmVudHNEaXNhYmxlZCkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlUG9pbnRlckV2ZW50cygpLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKSkuc3Vic2NyaWJlKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVwZGF0ZSBzY3JvbGxiYXIgdGh1bWIgd2hlbiB2aWV3cG9ydCBpcyBzY3JvbGxlZCBhbmQgd2hlbiBzY3JvbGxiYXIgY29tcG9uZW50IGlzIHVwZGF0ZWRcbiAgICAgIG1lcmdlKHRoaXMuY21wLnNjcm9sbGVkIGFzIE9ic2VydmFibGU8YW55PiwgdGhpcy5jbXAudXBkYXRlZCkucGlwZShcbiAgICAgICAgdGFwKCgpID0+IHRoaXMudGh1bWI/LnVwZGF0ZSgpKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveWVkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3llZC5jb21wbGV0ZSgpO1xuXG4gICAgLy8gQ2xlYW4gdXAgdmlld3BvcnQgc3RyZWFtcyBpZiB1c2VkXG4gICAgaWYgKHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgJiYgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCkge1xuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZC5jb21wbGV0ZSgpO1xuICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZC5jb21wbGV0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXRIb3ZlcmVkKHZhbHVlOiBib29sZWFuKTogdm9pZDtcbn1cbiJdfQ==