import { Output, Directive } from '@angular/core';
import { animationFrameScheduler, of, fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, map, mergeMap, pluck, takeUntil, tap } from 'rxjs/operators';
import { enableSelection, preventSelection, stopPropagation } from '../common';
import { NgScrollbar } from '../../ng-scrollbar';
import { TrackAdapter } from '../track/track';
// @dynamic
export class ThumbAdapter {
    constructor(cmp, track, thumbElement, document) {
        this.cmp = cmp;
        this.track = track;
        this.thumbElement = thumbElement;
        this.document = document;
        // Stream that emits dragging state
        this._dragging = new Subject();
        this.dragging = this._dragging.pipe(distinctUntilChanged());
    }
    get trackMax() {
        return this.track.size - this.size;
    }
    // Get thumb client rect
    get clientRect() {
        return this.thumbElement.getBoundingClientRect();
    }
    // Stream that emits when scrollbar thumb is clicked
    get clicked() {
        return fromEvent(this.thumbElement, 'mousedown', { passive: true }).pipe(stopPropagation());
    }
    // Calculate and update thumb position and size
    update() {
        const size = calculateThumbSize(this.track.size, this.viewportScrollSize, this.cmp.minThumbSize);
        const position = calculateThumbPosition(this.viewportScrollOffset, this.viewportScrollMax, this.trackMax);
        animationFrameScheduler.schedule(() => this.updateStyles(this.handleDirection(position, this.trackMax), size));
    }
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     */
    dragged(event) {
        let trackMaxStart;
        let scrollMaxStart;
        const dragStart = of(event).pipe(preventSelection(this.document), tap(() => {
            // Capture scrollMax and trackMax once
            trackMaxStart = this.trackMax;
            scrollMaxStart = this.viewportScrollMax;
            this.setDragging(true);
        }));
        const dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(stopPropagation());
        const dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap(() => this.setDragging(false)));
        return dragStart.pipe(pluck(this.pageProperty), map((pageOffset) => pageOffset - this.dragStartOffset), mergeMap((mouseDownOffset) => dragging.pipe(pluck(this.clientProperty), 
        // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
        map((mouseOffset) => mouseOffset - this.track.offset), map((offset) => scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart), map((position) => this.handleDrag(position, scrollMaxStart)), tap((position) => this.scrollTo(position)), takeUntil(dragEnd))));
    }
}
ThumbAdapter.decorators = [
    { type: Directive }
];
ThumbAdapter.ctorParameters = () => [
    { type: NgScrollbar },
    { type: TrackAdapter },
    { type: HTMLElement },
    { type: undefined }
];
ThumbAdapter.propDecorators = {
    dragging: [{ type: Output }]
};
/**
 * Calculate scrollbar thumb size
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    const scrollbarRatio = trackSize / contentSize;
    const thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3NyYy9saWIvc2Nyb2xsYmFyL3RodW1iL3RodW1iLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUMsV0FBVztBQUVYLE1BQU0sT0FBZ0IsWUFBWTtJQXFDaEMsWUFBZ0MsR0FBZ0IsRUFDaEIsS0FBbUIsRUFDbkIsWUFBeUIsRUFDekIsUUFBYTtRQUhiLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDaEIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixpQkFBWSxHQUFaLFlBQVksQ0FBYTtRQUN6QixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBdEM3QyxtQ0FBbUM7UUFDM0IsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDakMsYUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQztJQXFDakUsQ0FBQztJQWxCRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxLQUFNLENBQUMsSUFBSSxHQUFH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RixHQUFHLENBQUMsQ0FBQyxRQUFnQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQyxFQUNwRSxHQUFHLENBQUMsQ0FBQyxRQUFnQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQ2xELFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FDbkIsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7WUExRkYsU0FBUzs7O1lBSkQsV0FBVztZQUNYLFlBQVk7WUEyQzJCLFdBQVc7Ozs7dUJBbkN4RCxNQUFNOztBQXVHVDs7R0FFRztBQUNILFNBQVMsa0JBQWtCLENBQUMsU0FBaUIsRUFBRSxXQUFtQixFQUFFLFlBQW9CO0lBQ3RGLE1BQU0sY0FBYyxHQUFHLFNBQVMsR0FBRyxXQUFXLENBQUM7SUFDL0MsTUFBTSxTQUFTLEdBQUcsY0FBYyxHQUFHLFNBQVMsQ0FBQztJQUM3QyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLHNCQUFzQixDQUFDLGNBQXNCLEVBQUUsU0FBaUIsRUFBRSxRQUFnQjtJQUN6RixPQUFPLGNBQWMsR0FBRyxRQUFRLEdBQUcsU0FBUyxDQUFDO0FBQy9DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPdXRwdXQsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIsIG9mLCBmcm9tRXZlbnQsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIG1lcmdlTWFwLCBwbHVjaywgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBlbmFibGVTZWxlY3Rpb24sIHByZXZlbnRTZWxlY3Rpb24sIHN0b3BQcm9wYWdhdGlvbiB9IGZyb20gJy4uL2NvbW1vbic7XG5pbXBvcnQgeyBOZ1Njcm9sbGJhciB9IGZyb20gJy4uLy4uL25nLXNjcm9sbGJhcic7XG5pbXBvcnQgeyBUcmFja0FkYXB0ZXIgfSBmcm9tICcuLi90cmFjay90cmFjayc7XG5cbi8vIEBkeW5hbWljXG5ARGlyZWN0aXZlKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUaHVtYkFkYXB0ZXIge1xuXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIGRyYWdnaW5nIHN0YXRlXG4gIHByaXZhdGUgX2RyYWdnaW5nID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgQE91dHB1dCgpIGRyYWdnaW5nID0gdGhpcy5fZHJhZ2dpbmcucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICAvLyBSZXR1cm5zIGVpdGhlciAncGFnZVgnIG9yICdwYWdlWScgYWNjb3JkaW5nIHRvIHNjcm9sbGJhciBheGlzXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgcGFnZVByb3BlcnR5KCk6IHN0cmluZztcblxuICAvLyBSZXR1cm5zIGVpdGhlciAnY2xpZW50SGVpZ2h0JyBvciAnY2xpZW50V2lkdGgnIGFjY29yZGluZyB0byBzY3JvbGxiYXIgYXhpc1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IGNsaWVudFByb3BlcnR5KCk6IHN0cmluZztcblxuICBhYnN0cmFjdCBnZXQgZHJhZ1N0YXJ0T2Zmc2V0KCk6IG51bWJlcjtcblxuICAvLyBSZXR1cm5zIHRodW1iIHNpemUsIGNsaWVudEhlaWdodCBvciBjbGllbnRXaWR0aFxuICBhYnN0cmFjdCBnZXQgc2l6ZSgpOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbFNpemUoKTogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxPZmZzZXQoKTogbnVtYmVyO1xuXG4gIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbE1heCgpOiBudW1iZXI7XG5cbiAgZ2V0IHRyYWNrTWF4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudHJhY2shLnNpemUgLSB0aGlzLnNpemU7XG4gIH1cblxuICAvLyBHZXQgdGh1bWIgY2xpZW50IHJlY3RcbiAgZ2V0IGNsaWVudFJlY3QoKTogQ2xpZW50UmVjdCB7XG4gICAgcmV0dXJuIHRoaXMudGh1bWJFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICB9XG5cbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdGh1bWIgaXMgY2xpY2tlZFxuICBnZXQgY2xpY2tlZCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBmcm9tRXZlbnQodGhpcy50aHVtYkVsZW1lbnQsICdtb3VzZWRvd24nLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShzdG9wUHJvcGFnYXRpb24oKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJvdGVjdGVkIGNtcDogTmdTY3JvbGxiYXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgdHJhY2s6IFRyYWNrQWRhcHRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCB0aHVtYkVsZW1lbnQ6IEhUTUxFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIGRvY3VtZW50OiBhbnkpIHtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBhbmQgdXBkYXRlIHRodW1iIHBvc2l0aW9uIGFuZCBzaXplXG4gIHVwZGF0ZSgpIHtcbiAgICBjb25zdCBzaXplID0gY2FsY3VsYXRlVGh1bWJTaXplKHRoaXMudHJhY2shLnNpemUsIHRoaXMudmlld3BvcnRTY3JvbGxTaXplLCB0aGlzLmNtcC5taW5UaHVtYlNpemUhKTtcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNhbGN1bGF0ZVRodW1iUG9zaXRpb24odGhpcy52aWV3cG9ydFNjcm9sbE9mZnNldCwgdGhpcy52aWV3cG9ydFNjcm9sbE1heCwgdGhpcy50cmFja01heCk7XG4gICAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4gdGhpcy51cGRhdGVTdHlsZXModGhpcy5oYW5kbGVEaXJlY3Rpb24ocG9zaXRpb24sIHRoaXMudHJhY2tNYXgpLCBzaXplKSk7XG4gIH1cblxuICAvKipcbiAgICogU3RyZWFtIHRoYXQgZW1pdHMgdGhlICdzY3JvbGxUbycgcG9zaXRpb24gd2hlbiBhIHNjcm9sbGJhciB0aHVtYiBlbGVtZW50IGlzIGRyYWdnZWRcbiAgICogVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGh1bWIgZHJhZyBldmVudCB1c2luZyB2aWV3cG9ydCBvciBzY3JvbGxiYXIgcG9pbnRlciBldmVudHNcbiAgICovXG4gIGRyYWdnZWQoZXZlbnQ6IGFueSk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgbGV0IHRyYWNrTWF4U3RhcnQ6IG51bWJlcjtcbiAgICBsZXQgc2Nyb2xsTWF4U3RhcnQ6IG51bWJlcjtcblxuICAgIGNvbnN0IGRyYWdTdGFydCA9IG9mKGV2ZW50KS5waXBlKFxuICAgICAgcHJldmVudFNlbGVjdGlvbih0aGlzLmRvY3VtZW50KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIC8vIENhcHR1cmUgc2Nyb2xsTWF4IGFuZCB0cmFja01heCBvbmNlXG4gICAgICAgIHRyYWNrTWF4U3RhcnQgPSB0aGlzLnRyYWNrTWF4O1xuICAgICAgICBzY3JvbGxNYXhTdGFydCA9IHRoaXMudmlld3BvcnRTY3JvbGxNYXg7XG4gICAgICAgIHRoaXMuc2V0RHJhZ2dpbmcodHJ1ZSk7XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY29uc3QgZHJhZ2dpbmcgPSBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNlbW92ZScsIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKHN0b3BQcm9wYWdhdGlvbigpKTtcblxuICAgIGNvbnN0IGRyYWdFbmQgPSBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNldXAnLCB7IGNhcHR1cmU6IHRydWUgfSkucGlwZShcbiAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxuICAgICAgZW5hYmxlU2VsZWN0aW9uKHRoaXMuZG9jdW1lbnQpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0RHJhZ2dpbmcoZmFsc2UpKVxuICAgICk7XG5cbiAgICByZXR1cm4gZHJhZ1N0YXJ0LnBpcGUoXG4gICAgICBwbHVjazxhbnksIG51bWJlcj4odGhpcy5wYWdlUHJvcGVydHkpLFxuICAgICAgbWFwKChwYWdlT2Zmc2V0OiBudW1iZXIpID0+IHBhZ2VPZmZzZXQgLSB0aGlzLmRyYWdTdGFydE9mZnNldCksXG4gICAgICBtZXJnZU1hcCgobW91c2VEb3duT2Zmc2V0OiBudW1iZXIpID0+IGRyYWdnaW5nLnBpcGUoXG4gICAgICAgIHBsdWNrKHRoaXMuY2xpZW50UHJvcGVydHkpLFxuICAgICAgICAvLyBDYWxjdWxhdGUgaG93IGZhciB0aGUgcG9pbnRlciBpcyBmcm9tIHRoZSB0b3AvbGVmdCBvZiB0aGUgc2Nyb2xsYmFyIChtaW51cyB0aGUgZHJhZ09mZnNldCkuXG4gICAgICAgIG1hcCgobW91c2VPZmZzZXQ6IG51bWJlcikgPT4gbW91c2VPZmZzZXQgLSB0aGlzLnRyYWNrIS5vZmZzZXQpLFxuICAgICAgICBtYXAoKG9mZnNldDogbnVtYmVyKSA9PiBzY3JvbGxNYXhTdGFydCAqIChvZmZzZXQgLSBtb3VzZURvd25PZmZzZXQpIC8gdHJhY2tNYXhTdGFydCksXG4gICAgICAgIG1hcCgocG9zaXRpb246IG51bWJlcikgPT4gdGhpcy5oYW5kbGVEcmFnKHBvc2l0aW9uLCBzY3JvbGxNYXhTdGFydCkpLFxuICAgICAgICB0YXAoKHBvc2l0aW9uOiBudW1iZXIpID0+IHRoaXMuc2Nyb2xsVG8ocG9zaXRpb24pKSxcbiAgICAgICAgdGFrZVVudGlsKGRyYWdFbmQpXG4gICAgICApKVxuICAgICk7XG4gIH1cblxuICAvLyBTZXQgZHJhZ2dpbmcgc3RhdGVcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldERyYWdnaW5nKHZhbHVlOiBib29sZWFuKTogdm9pZDtcblxuICAvLyBTY3JvbGwgdmlld3BvcnQgaW5zdGFudGx5XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzY3JvbGxUbyhwb3NpdGlvbjogbnVtYmVyKTogdm9pZDtcblxuICAvLyBVcGRhdGUgdGh1bWIgZWxlbWVudCBzaXplIGFuZCBwb3NpdGlvblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlU3R5bGVzKHBvc2l0aW9uOiBudW1iZXIsIHNpemU6IG51bWJlcik6IHZvaWQ7XG5cbiAgLy8gSGFuZGxlIGRyYWdnaW5nIHBvc2l0aW9uIChTdXBwb3J0IExUUiBhbmQgUlRMIGRpcmVjdGlvbnMgZm9yIHRoZSBob3Jpem9udGFsIHNjcm9sbGJhcilcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURyYWcocG9zaXRpb246IG51bWJlciwgc2Nyb2xsTWF4PzogbnVtYmVyKTogbnVtYmVyO1xuXG4gIC8vIEhhbmRsZSBzY3JvbGxpbmcgcG9zaXRpb24gKFN1cHBvcnQgTFRSIGFuZCBSVEwgZGlyZWN0aW9ucyBmb3IgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyKVxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgaGFuZGxlRGlyZWN0aW9uKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcik6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgc2Nyb2xsYmFyIHRodW1iIHNpemVcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlVGh1bWJTaXplKHRyYWNrU2l6ZTogbnVtYmVyLCBjb250ZW50U2l6ZTogbnVtYmVyLCBtaW5UaHVtYlNpemU6IG51bWJlcik6IG51bWJlciB7XG4gIGNvbnN0IHNjcm9sbGJhclJhdGlvID0gdHJhY2tTaXplIC8gY29udGVudFNpemU7XG4gIGNvbnN0IHRodW1iU2l6ZSA9IHNjcm9sbGJhclJhdGlvICogdHJhY2tTaXplO1xuICByZXR1cm4gTWF0aC5tYXgofn50aHVtYlNpemUsIG1pblRodW1iU2l6ZSk7XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHNjcm9sbGJhciB0aHVtYiBwb3NpdGlvblxuICovXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHNjcm9sbFBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyLCB0cmFja01heDogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIHNjcm9sbFBvc2l0aW9uICogdHJhY2tNYXggLyBzY3JvbGxNYXg7XG59XG4iXX0=